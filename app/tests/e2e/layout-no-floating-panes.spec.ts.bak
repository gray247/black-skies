import { test, expect } from './_electron.fixture';
import { bootstrapHarness } from './_bootstrap';

test.describe('Layout regression: no floating panes', () => {
  test('does not auto-spawn floating panes on project load', async ({ page, electronApp }) => {
    await bootstrapHarness(page);

    // Ensure only the primary window is present.
    expect(electronApp.windows().length).toBe(1);

    await page.waitForSelector('[data-testid="dock-workspace"]', { timeout: 30_000 });

    const floatingSelectors = [
      '[data-testid*="float"]',
      '.float-window',
      '[role="dialog"]',
      '.floating-window',
    ];
    for (const selector of floatingSelectors) {
      const elements = await page.locator(selector).all();
      expect(elements.length, `Unexpected floating selector: ${selector}`).toBe(0);
    }

    // Default preset panes should be visible; analytics surfaces should not auto-open.
    const paneTitle = (text: string) => page.locator('.dock-pane__titlebar', { hasText: text }).first();
    await expect(paneTitle('Outline')).toBeVisible();
    await expect(paneTitle('Draft preview')).toBeVisible();
    await expect(paneTitle('Story insights')).toBeVisible();
    await expect(paneTitle('Corkboard')).toBeVisible();

    await expect(page.getByText(/Story Insights Dashboard/i)).toBeVisible();
    await expect(page.locator('[data-pane-id="relationshipGraph"]')).toHaveCount(0);
    await expect(page.locator('[data-pane-id="timeline"]')).toHaveCount(0);
  });
});
