# Black Skies Services Review (2024-04-21)

## Overview
This review focuses on the FastAPI service under `services/src/blackskies/services`. I sampled route handlers, persistence helpers, and supporting utilities to surface correctness risks and identify test gaps. Existing contract tests in `services/tests/test_app.py` already exercise most endpoints, so the observations below emphasize scenarios not currently covered and edge cases that can regress silently.

## Notable Risks & Weaknesses
1. **Front-matter data loss on write paths.** `DraftPersistence._render` only emits keys listed in the private `_FIELD_ORDER`, so any additional metadata present in front matter (for example, custom extension fields or new schema attributes) will be dropped the next time a draft is generated, rewritten, or accepted. Because `_merge_meta` preserves unknown keys in-memory, this truncation is easy to miss until data disappears on disk.【F:services/src/blackskies/services/persistence.py†L49-L155】【F:services/src/blackskies/services/app.py†L469-L494】
2. **Manual `.env` parsing can mis-handle common formats.** `ServiceSettings.from_environment` reads `.env` lines via simple string splitting without honouring quoting, escaping, or export prefixes. Values that include `=` or spaces in quotes (e.g., `BLACKSKIES_PROJECT_BASE_DIR="/tmp/black skies"`) will be trimmed incorrectly, and the method stops at the first matching line without validating the path exists.【F:services/src/blackskies/services/config.py†L11-L34】
3. **Diff engine lacks regression coverage.** `compute_diff` is central to rewrite responses but currently has no direct unit tests. Any refactor to the diff computation or anchor logic could silently skew the payload contract relied upon by the desktop client.【F:services/src/blackskies/services/diff_engine.py†L8-L46】【F:services/tests/test_app.py†L570-L618】
4. **Budget loader trusts float coercion.** `_load_project_budget_state` calls `float()` on the persisted values after Pydantic validation. If a future schema change allows strings with currency symbols or localisation (e.g., `"5,000"`), this conversion will raise and bubble out as a 500. A guard or normalisation strategy would make the service more resilient.【F:services/src/blackskies/services/app.py†L599-L664】
5. **Export meta header coverage is shallow.** While `services/tests/test_app.py::test_draft_export_manuscript_success` already exercises the `include_meta_header=True` path, there are no unit-level assertions on `_build_meta_header` itself. A regression in the header formatting logic could slip past contract tests and leave exported manuscripts missing the POV/purpose hints that the GUI expects when toggled.【F:services/src/blackskies/services/app.py†L320-L356】【F:services/tests/test_app.py†L770-L816】

## Recommended Tests
- **Persistence regression:** Add a unit test around `DraftPersistence._render` that starts from front matter containing an unknown key (e.g., `"scene_mood"`) and asserts the rendered markdown preserves it. This will currently fail, demonstrating the data-loss bug and guiding a fix.【F:services/src/blackskies/services/persistence.py†L109-L155】
- **Diff payload contract:** Introduce a focused test for `compute_diff` that exercises replace/insert/delete opcodes and validates anchor offsets, ensuring the shape matches what `/api/v1/draft/rewrite` returns today.【F:services/src/blackskies/services/diff_engine.py†L8-L46】
- **Export meta header:** Add focused unit coverage for `_build_meta_header` that validates the rendered header structure (purpose, emotion, POV) so regressions surface before the contract test fails downstream.【F:services/src/blackskies/services/app.py†L320-L356】
- **Settings `.env` parsing:** Create a unit test for `ServiceSettings.from_environment` that feeds a `.env` file containing quoted paths and additional whitespace to capture the parsing limitations and drive a more robust loader.【F:services/src/blackskies/services/config.py†L19-L34】
- **Budget normalisation guard:** Add a unit test for `_load_project_budget_state` that simulates a `project.json` with localised numeric strings to confirm the service logs a validation error and falls back to defaults instead of raising.【F:services/src/blackskies/services/app.py†L599-L664】

## Additional Suggestions
- Document the expected front-matter schema in `/docs/exports.md` (or a new appendix) so client teams know which keys are safe until `_render` is made extensible.
- Consider promoting helper modules (`diagnostics`, `persistence`, `diff_engine`) into dedicated unit test modules to keep contract tests lean and speed up debugging when failures occur.
- When revisiting settings loading, prefer `pydantic.Settings` or `python-dotenv` style parsing to match developer expectations and reduce brittle string handling.

## 2025-10-09 — Comprehensive Code Review Snapshot

### Summary
| Review Area | Key Observation |
| --- | --- |
| Syntax & formatting | `metrics_endpoint` hard-codes a lowercase `content-type` header; using canonical casing keeps responses aligned with other handlers and avoids surprising downstream header checks.【F:services/src/blackskies/services/routers/health.py†L35-L40】 |
| Logical consistency | Legacy shims add `Deprecation`/`Sunset` headers but omit the `Link` successor pointer required by the locked API contract.【F:services/src/blackskies/services/app.py†L84-L119】【F:docs/endpoints.md†L6-L9】 |
| Security | Snapshot create/restore follows filesystem entries verbatim, so crafted symlinks inside a project can traverse or duplicate arbitrary host paths during backup/restore.【F:services/src/blackskies/services/persistence.py†L216-L377】 |
| Performance | Snapshot creation runs `shutil.copytree` synchronously inside request handlers, copying entire project directories on every accept/restore path and blocking the request thread for large projects.【F:services/src/blackskies/services/persistence.py†L216-L377】 |
| Architectural smell / coupling | Global exception handlers mint fresh trace IDs instead of reusing the middleware-provided context, fragmenting diagnostics across subsystems that rely on shared trace identifiers.【F:services/src/blackskies/services/app.py†L151-L195】 |
| Test coverage gaps | Contract tests validate legacy headers but never assert the missing `Link` successor header, so the spec regression ships silently.【F:services/tests/test_app.py†L366-L429】 |
| Docstring/readability | The `draft` router packs >1,100 lines of mixed helpers and route handlers into a single module, making navigation and comprehension difficult despite individual docstrings.【F:services/src/blackskies/services/routers/draft.py†L1-L1203】 |
| Dependency safety | CI installs floating `.[dev]` requirements instead of the pinned lockfile, so builds can break on upstream releases even though the repo ships a frozen dependency set.【F:.github/workflows/eval.yml†L1-L27】【F:requirements.lock†L1-L22】 |
| CI/CD reliability | The workflow relies on `pip install .[dev]` without caching or lock enforcement, so a failing upstream dependency stalls the whole pipeline and masks regressions unrelated to the PR.【F:.github/workflows/eval.yml†L15-L27】 |
| Maintainability & complexity | Large synchronous filesystem operations and the monolithic `draft` router compound maintenance risk; extracting persistence and budget logic into focused services would reduce cognitive load.【F:services/src/blackskies/services/persistence.py†L216-L377】【F:services/src/blackskies/services/routers/draft.py†L1-L1203】 |

### Detailed Notes

1. **Legacy successor headers missing.** The locked API contract requires every legacy shim to emit a `Link` header that points to the canonical `/api/v1/...` endpoint. `_apply_legacy_headers` and `_apply_legacy_headers_to_exception` only attach `Deprecation` and `Sunset`, so clients lose the upgrade hint and contract compliance is violated.【F:services/src/blackskies/services/app.py†L84-L119】【F:docs/endpoints.md†L6-L9】 A regression test that asserts `Link` on both success and error flows for each shim would guard the fix.【F:services/tests/test_app.py†L366-L429】
2. **Trace correlation leaks.** The global `HTTPException` and validation handlers call `ensure_trace_id()` directly, minting a fresh UUID instead of reusing the middleware's resolved trace. Any FastAPI error that bypasses the middleware (startup hooks, dependencies raising before the middleware runs) will now log under a new trace, breaking cross-service correlation and the spec guarantee that payload `trace_id` matches the header.【F:services/src/blackskies/services/app.py†L151-L195】 Thread the active context via `_resolve_active_trace_id` to keep parity.
3. **Snapshot symlink exposure.** `SnapshotPersistence.create_snapshot` and `_restore_directory` delegate to `shutil.copytree` with `dirs_exist_ok=True`. Because no `symlinks=True` guard or `follow_symlinks=False` sanitisation is applied, a project owner can craft `drafts` entries that point outside the project root; snapshotting or restoring follows those links and copies arbitrary host files, expanding the attack surface of a desktop app that trusts local content.【F:services/src/blackskies/services/persistence.py†L216-L377】 Add explicit `copytree(..., symlinks=True)` plus target validation or reject snapshots containing symlinks.
4. **Snapshot throughput bottleneck.** The same snapshot code path executes during `/api/v1/draft/accept` and `/api/v1/draft/recovery/restore`, so copying the entire `drafts` tree and large outline artifacts happens synchronously while the request waits. For multi-scene projects this can take several seconds and block incoming requests. Consider offloading heavy copying to a background task queue or incremental snapshot strategy.【F:services/src/blackskies/services/persistence.py†L216-L377】
5. **Monolithic draft router.** `routers/draft.py` combines budget loaders, diffing, export helpers, wizard snapshots, and every `/draft` route in a single ~1.2k line module. The sheer size makes it hard to reason about shared helpers such as `_load_project_budget_state` and `_compile_manuscript` in isolation and encourages tight coupling between unrelated concerns (preflight, accept, export, critique). Splitting persistence, budgeting, and rewrite helpers into dedicated service modules would improve readability and unlock targeted tests.【F:services/src/blackskies/services/routers/draft.py†L1-L1203】
6. **Header casing inconsistency.** `metrics_endpoint` sets `headers={"content-type": ...}` while other routes rely on FastAPI's default `Content-Type`. Although HTTP header names are case-insensitive, lower-case constants can confuse debugging scripts and violate internal style guides that mirror RFC casing. Aligning the header name keeps responses uniform.【F:services/src/blackskies/services/routers/health.py†L35-L40】
7. **CI drift from dependency locks.** The GitHub workflow installs dynamic dependencies via `pip install .[dev]`, ignoring `requirements.lock`. A sudden upstream release (for example `pytest>=8.4`) can break CI even though the repo already curates frozen requirements for reproducibility. Switching the workflow to `pip install -r requirements.lock -r requirements.dev.lock` (or generating wheels from the lock file) keeps CI deterministic.【F:.github/workflows/eval.yml†L15-L27】【F:requirements.lock†L1-L22】

