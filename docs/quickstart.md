# Quickstart / Smoke Test Guide

This document is the handoff for QA and support testers who want a clean way to bring the desktop app online without remembering the repo history. It assumes a fresh clone on Windows 11.

> **Release target:** `v1.0.0-rc1` (Phase 7).

---

## Prerequisites

- Windows 11 (Developer Mode **enabled** if you plan to run the packaging scripts).
- Python 3.11 on `PATH`.
- Node.js 20.x (Corepack enabled).
- Git + PowerShell 7 (or Windows PowerShell 5.1).

> **Verify:**
> ```powershell
> node -v      # -> v20.x
> python --version  # -> 3.11.x
> corepack --version
> ```

- Install the Python dev lock (`pip install -r requirements.dev.lock`) so optional modules like `pydantic-settings` are present before you run the smoke or load scripts.

### Offline prerequisites (air-gapped QA)

- While you still have network access, populate the cached wheels so Python installs succeed offline:
  ```bash
  bash scripts/freeze_wheels.sh
  ```
  The script writes all locked dependencies under `vendor/wheels/`; see the Milestone 0 verification notes for refresh commands and expected artifacts.【F:docs/milestone0_verification.md†L1-L56】【F:docs/milestone0_verification.md†L63-L87】
- Refresh the virtual environment from those wheels before disconnecting:
  ```bash
  bash scripts/setup
  ```
  `scripts/setup` prefers `vendor/wheels/` and leaves `.env` untouched if it already exists.【F:scripts/setup†L1-L129】
- Copy `.env.example` to `.env`, confirm it opts into the local provider stack, and point it at a valid project directory. Set the mode to `offline` (the default), keep the dummy key, and include `BLACKSKIES_PROJECT_BASE_DIR` for your sample content:
  ```ini
  OPENAI_API_KEY=dummy
  BLACK_SKIES_MODE=offline
  BLACKSKIES_PROJECT_BASE_DIR=C:\\Dev\\black-skies\\sample_project
  ```
-  The services enforce that `BLACKSKIES_PROJECT_BASE_DIR` exists, and the UI reads the same value when launching the smoke scripts.【F:services/src/blackskies/services/config.py†L14-L74】【F:README.md†L32-L55】 The optional budget/plugin overrides in `.env.example` stay at the RC1 defaults ($12.50 soft / $25.00 hard) for smoke tests; adjust them only when packaging a customized build.
- Copy the `sample_project/Esther_Estate` folder (and any additional project assets) to the offline machine so QA can load the reference project without network fetches.【F:README.md†L76-L95】
- With `BLACK_SKIES_MODE=offline` (the default), the agents never attempt external API calls; the privacy policy confirms no background network traffic in local mode.【F:docs/policies.md†L1-L35】【F:services/src/blackskies/services/settings.py†L1-L58】
- When `config/runtime.yaml` specifies a port range outside 1–65535, the startup log now emits `[config] Adjusted service.port_range…` and clamps the values automatically; this is expected for stale configs copied from earlier milestones.【F:app/shared/config/runtime.ts†L252-L292】

---

## One‑Time Bootstrap

```powershell
# from repo root
powershell.exe -ExecutionPolicy Bypass -File .\start-codex.ps1 -OnlyTests
```

- Creates `.venv` and installs locked Python deps.
- Installs pinned pnpm + workspace packages.
- Runs the full pytest + Vitest suite as a smoke check.

If everything is green you are ready to launch the GUI.

---

## Launching the App (Smoke Test)

```powershell
powershell.exe -ExecutionPolicy Bypass -File .\start-codex.ps1 -SmokeTest
```

What it does:

1. Ensures deps are synchronized and builds the Electron main bundle (`pnpm --filter app build:main`).
2. Opens a PowerShell window running `pnpm --filter app dev -- --host 127.0.0.1 --port 5173` (Vite renderer).
3. Opens a second window running the real Electron shell (`pnpm --filter app exec electron ..\dist-electron\main\main.js`) with the correct env vars (`ELECTRON_RENDERER_URL`, `BLACKSKIES_PYTHON`, `BLACKSKIES_PROJECT_BASE_DIR`).
4. Electron spawns the FastAPI service automatically; the status pill should transition from “Checking writing tools” to “Ready” once `/api/v1/healthz` responds.

Close the two windows to stop the app.

---

### Offline smoke checklist (QA)

Use this when verifying an air-gapped build. Perform the steps in order after disconnecting from the network:

1. **Dependency cache** — Confirm `vendor/wheels/` still contains the wheel set generated by `scripts/freeze_wheels.sh` (look for timestamped `.whl` files).【F:docs/milestone0_verification.md†L63-L87】
2. **Environment** — Open `.env` and verify the entries from the offline prerequisites (`BLACK_SKIES_MODE=offline`, `BLACKSKIES_PROJECT_BASE_DIR=…`). The loader now emits the `BLACK_SKIES_MODE` key by default, but legacy `.env` files with `BLACK_SKIES_BLACK_SKIES_MODE` still work and log a reminder to rename it.【F:services/src/blackskies/services/settings.py†L1-L134】【F:services/src/blackskies/services/config.py†L14-L74】
3. **Project assets** — Ensure the directory referenced by `BLACKSKIES_PROJECT_BASE_DIR` includes `sample_project/Esther_Estate` (or your test project) so the wizard can load content.【F:README.md†L76-L95】
4. **Smoke script** — Run `powershell.exe -ExecutionPolicy Bypass -File .\start-codex.ps1 -SmokeTest`. The script should complete without hitting the network; if packages are missing rerun the cache refresh sequence while online.【F:start-codex.ps1†L145-L261】
5. **UI confirmation** — When Electron opens, watch the status pill advance to “Ready” and confirm `/api/v1/healthz` passes without external calls (monitor via Windows Resource Monitor or offline firewall logs).【F:docs/policies.md†L1-L35】

---

## Manual Launch (if you prefer explicit terminals)

```powershell
# window 1 (renderer)
cd C:\Dev\black-skies
pnpm --filter app dev -- --host 127.0.0.1 --port 5173

# window 2 (electron)
cd C:\Dev\black-skies\app
$env:ELECTRON_RENDERER_URL = 'http://127.0.0.1:5173/'
$env:BLACKSKIES_PYTHON     = 'C:\Dev\black-skies\.venv\Scripts\python.exe'
pnpm exec electron ..\dist-electron\main\main.js
```

The renderer window keeps Vite hot reloading; close it to stop the dev server. The Electron window spawns a child Python process (FastAPI) and cleans it up on exit.

---

### Runtime configuration overrides

Defaults for port ranges, health probe timing, bundled Python interpreters, analytics thresholds, and the draft synthesizer heuristics live in `config/runtime.yaml`. Update this file (or point `BLACKSKIES_CONFIG_PATH` at a custom copy) when you need to harden deployments—changes are picked up by both the FastAPI backend and the Electron main/preload processes. The `draft_synthesizer` section lets you override POV/goal/conflict/turn/emotion lists or adjust the word-target curve without touching code, which is handy when running branded demos or expanding the companion cast.

---

## Packaging (optional)

To produce the unpacked build for QA:

```powershell
# ensure Developer Mode is enabled so symlinks can be created
$env:ELECTRON_BUILDER_DISABLE_CODE_SIGNING = '1'
pnpm --filter app run package:dir
```

The output lands in `app/release/win-unpacked`. Running `package:win` generates the NSIS installer and portable EXE (requires NSIS in `PATH`).

> If you see `Cannot create symbolic link : A required privilege is not held by the client`, turn on Windows Developer Mode or run the packaging step from an elevated PowerShell session.

---

## Sample Project

Use the bundled `sample_project/Esther_Estate` for smoke tests:

- Automated: `./scripts/smoke.sh` (or `powershell -File .\scripts\smoke.ps1`) bootstraps the venv, starts the API, and runs three Outline → Writing → Feedback → Accept cycles against `proj_esther_estate`.
- Manual: Launch the desktop shell, choose **Open Project**, browse to `sample_project/Esther_Estate`, and step through the Outline → Writing → Feedback → Accept flow to confirm the budget pill and recovery banner respond as expected.
- Load sanity: python scripts/load.py --total-cycles 4 --concurrency 2 --start-service --scene-count 4 autostarts the FastAPI bridge, waits for /api/v1/healthz, rotates four scenes, and verifies critique telemetry updates the budget meter and ledger.

### Recovery banner smoke (manual trigger)

If you need to force the crash recovery banner during a smoke run, call the recovery tracker before relaunching the Electron shell:

```powershell
cd C:\Dev\black-skies
.\.venv\Scripts\python.exe -c "from blackskies.services.config import ServiceSettings; from blackskies.services.routers.recovery import RecoveryTracker; tracker = RecoveryTracker(ServiceSettings()); tracker.mark_needs_recovery('proj_esther_estate', reason='smoke-test manual')"
Get-Content sample_project\proj_esther_estate\history\recovery\state.json
```

The JSON should show `"status": "needs-recovery"` and `"needs_recovery": true`. Launch Vite and Electron afterwards; the banner appears as soon as the project loads, and it clears once **Restore snapshot** succeeds.

---

## Troubleshooting

| Symptom | Fix |
| --- | --- |
| `pnpm` not found | Ensure Corepack is enabled (`corepack enable`). |
| FastAPI health probe stuck on CORS | The service now ships with CORS allowing `http://127.0.0.1:5173`; restart if you modified it. |
| Electron fails with `ERR_REQUIRE_ESM` | Rebuild the main bundle (`pnpm --filter app build:main`) to ensure the CommonJS shims are present. |
| Packaging fails downloading `winCodeSign` | Enable Developer Mode or run the command in an elevated shell. |
| Smoke script fails offline with missing wheels | Rebuild the cache while online (`bash scripts/freeze_wheels.sh`) and rerun `bash scripts/setup`; see the Milestone 0 checklist for the expected artifacts.【F:docs/milestone0_verification.md†L63-L87】【F:scripts/setup†L1-L129】 |
| Services attempt external providers | Set `BLACK_SKIES_MODE=offline` (default) and a valid `BLACKSKIES_PROJECT_BASE_DIR` in `.env`; refer to the service configuration notes in the README. Legacy `.env` files using `BLACK_SKIES_BLACK_SKIES_MODE` still load but log a rename warning.【F:services/src/blackskies/services/settings.py†L1-L134】【F:services/src/blackskies/services/config.py†L14-L74】【F:README.md†L32-L55】 |

For deeper debugging see `docs/packaging.md`, `docs/tests.md`, and `docs/specs/endpoints.md`.
